<!DOCTYPE html>
<html lang="it">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

  <title>Dashboard</title>

  <!-- Favicon -->
  <link rel="shortcut icon" href="/l-amore-chiama-l-amore-e-urgente/images/logo/logo-5p2p-256.png">

  <!-- CSS  -->
  <link rel="stylesheet" href="/l-amore-chiama-l-amore-e-urgente/assets/css/reset.css" media="all">
  <link rel="stylesheet" href="/l-amore-chiama-l-amore-e-urgente/assets/css/basscss.min.css" media="all">
  <link rel="stylesheet" href="/l-amore-chiama-l-amore-e-urgente/assets/css/colors.css" media="all">
  <link rel="stylesheet" href="/l-amore-chiama-l-amore-e-urgente/assets/css/style.css" media="all">
  <!-- <link rel="stylesheet" href="/l-amore-chiama-l-amore-e-urgente/assets/css/dashboard.css" media="all"> -->

  <link href='https://fonts.googleapis.com/css?family=Roboto:400,900,400italic,700|Roboto+Condensed:300' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,700" rel="stylesheet">
  <!-- awesome icons -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

</head>

<body>

  <header class="top main">
    <img class="top" src="/l-amore-chiama-l-amore-e-urgente/images/logo/5pani2pesci-2017-white-text-200.png" alt="5pani2pesci">
    <div id="logout" class="top">
      <i class="fa fa-sign-out" aria-hidden="true"></i>
      <!-- <button id="logout" name="logout">Logout</button> -->
    </div>
  </header>


  <div id="content">
    <div class="page-content">
      <!-- <button id="logout" name="logout">Logout</button> -->

<!--  MODAL DIALOG -->

<div id="editUser" class="dialog">
  <div id="opacityPage" class="opacity page"></div>
  <div class="dialog content">
    <h2>EditX</h2>

    <div class="form">
      <input id="name" type="text" name="name" placeholder="Nome e Cognome" />
      <input id="email" type="text" name="email" placeholder="Email" />
      <input id="city" type="text" name="city" placeholder="Da dove vieni?" />
      <input id="mobile" type="text" name="mobile" placeholder="Cellulare" class="medium input" />
      <input id="age" type="text" name="age" placeholder="Età (anni)" class="small input" />
      <input id="intolerance" type="text" name="intolerance" placeholder="Intolleranze" />

    <ul class="radio">
    <!-- <p class="small text">Hai intolleranze alimentari?</p> -->
     <li id="user">
       <input id="user-radio" type="radio" name="selector" checked="" />
       <label for="f-option">Partecipante</label>
       <div class="check"></div>
       <!-- <input  id="intolerance"     type="text"  name="intolerance"    placeholder="Quali?"   disabled/> -->
     </li>
     <li id="member">
       <input id="member-radio" type="radio" name="selector" />
       <label for="s-option">Servizio</label>
       <div class="check"></div>
       <!-- <div class="check"><div class="inside"></div></div> -->
     </li>
     <li id="staff">
       <input id="staff-radio" type="radio" name="selector" />
       <label for="s-option">Staff</label>
       <div class="check"></div>
       <!-- <div class="check"><div class="inside"></div></div> -->
     </li>
    </ul>
    <div class="" style="text-align: right">
      <button id="update" class="input-btn" name="update">Update</button>
      <button id="close" class="input-btn white" name="cancel">Close</button>
    </div>
  </div>

  <div class="separator"></div>
  <div class="form">
    <input id="name" type="text" name="name" placeholder="type DELETE to remove user" />
    <div class="" style="text-align: right">
      <button id="delete" class="input-btn white color-alert" name="delete">Delete</button>
    </div>
  </div>

    <!-- <div class="centered box"> -->
    <!-- </div> -->

  </div>
</div>

<!--  FIREBASE LIST -->
<div id="people"></div>

<div class="separator"></div>

    </div>
  </div>

  <footer class="">
    <div class="max-width-3 mx-auto"><p>&nbsp;</p></div>
  </footer>


  <!--  Scripts-->
  
<!-- <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script> -->
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-database.js"></script>
<!-- <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-messaging.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-storage.js"></script> -->

<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDrv83fRdbIbRC5yYxBJKhCHACP-ld4UFI",
    authDomain: "app-5pani2pesci.firebaseapp.com",
    databaseURL: "https://app-5pani2pesci.firebaseio.com",
    projectId: "app-5pani2pesci",
    storageBucket: "app-5pani2pesci.appspot.com",
    messagingSenderId: "423190157517"
  };
  firebase.initializeApp(config);
// CONFIG
  var refEvent = '/events/2017-11-paderno'
  var refUnique = firebase.database().ref(refEvent+'/unique')
  var refPeople = firebase.database().ref(refEvent+'/people')
</script>

<script type="text/javascript">
// Set page privacy via yaml page key

var private = true

</script>

<script type="text/javascript">

function signOut() {
  firebase.auth().signOut()
}

function toggleSignIn() {
  var id = 'signin'
  var defaultBtnText = document.getElementById(id).innerText
  document.getElementById(id).innerText = '...'
  if (firebase.auth().currentUser) {
    firebase.auth().signOut()
   } else {
     setTimeout(function(){document.getElementById(id).innerText = defaultBtnText}, 1000)
     var email = document.getElementById('email').value
     var password = document.getElementById('password').value
     firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
       if (error.code === 'auth/wrong-password') {
         alert('Wrong password.')
       } else {
         alert(error.message)
       }
       console.log(error)
     })
   }
 }

function createNewUser() {
  var email    = document.getElementById('email').value
  var password = document.getElementById('password').value
  var passwordCheck = document.getElementById('passwordCheck').value
  if (password === passwordCheck && password !== '') {
    // console.log(email)
    // console.log(password)
    firebase.auth().createUserWithEmailAndPassword(email, password)
    .then((user) => {
      console.log(user.email)
      location.href = 'dashboard'
    })
    .catch((error) => {
      console.log(error)
      var errorCode = error.code
      var errorMessage = error.message
    })
  } else {
   console.log('the two passwords are different!')
  }
}


function loginPage(user) {
  // firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    // var displayName = user.displayName;
    var email = user.email;
    var uid = user.uid;
    document.getElementById('signin').textContent = 'Sign out'
    if (/login/.test(location.href)) location.href='dashboard'

  } else {
    console.log('Not logged')
    document.getElementById('signin').textContent = 'Sign in'
    // if (private) location.href = 'login'
  }
  // })
  document.getElementById('signin').addEventListener('click', toggleSignIn, false);
  document.getElementById('email').onkeydown = function(e){
     if(e.keyCode == 13) toggleSignIn()
  }
  document.getElementById('password').onkeydown = function(e){
     if(e.keyCode == 13) toggleSignIn()
  }
}

function newUser() {
  document.getElementById('newAccount').addEventListener('click', createNewUser, false)
}

function registerUser(user) {
  // formAlert(name+" risulta essere già registrato")
  //
  var name = user.name
  // var refUnique = firebase.database().ref(ref+'/unique')
  // var refPeople = firebase.database().ref(ref+'/people')
  refUnique.orderByChild("name").equalTo(name).once('value', function(snapshot) {
    if (snapshot.val() === null) {
      // console.log('name is unique');
      refUnique.push({name: user.name})
      refPeople.push(user, function (error) {
        if (error) {
          console.log(error);
        } else {
          console.log('data saved correctly')
          location.href = 'completed'
        }
      })
    } else {
      // console.log('name failed!');
      formAlert(name+" risulta essere già registrato")
    }
  })
}


function registration() {
  document.getElementById('logout').style.visibility = "hidden";
  var alert = {show: false}
  document.getElementById('y-intollerances').addEventListener('click', function(){
    document.getElementById('y-radio').checked = true;
    document.getElementById('intolerance').disabled = false;
  }, false)
  document.getElementById('n-intollerances').addEventListener('click', function(){
    document.getElementById('n-radio').checked = true;
    document.getElementById('intolerance').disabled = true;
  }, false)

  document.getElementById('registration').addEventListener('click', function () {
    document.getElementById('registration').innerText = '...'
    setTimeout(function(){document.getElementById('registration').innerText = 'Invia'}, 1000)
    var name = capitalize(document.getElementById('name').value.trim())
    var email = document.getElementById('email').value.trim().toLowerCase()
    var city = capitalize(document.getElementById('city').value.trim())
    var mobile = document.getElementById('mobile').value.trim()
    var age = document.getElementById('age').value.trim()
    var intolerance = capitalize(document.getElementById('intolerance').value.trim())
    var user = {
      name: name,
      email: email,
      city: city,
      mobile: mobile,
      age: age,
      intolerance: intolerance
    }
    if (anyEmpty([name,email,city,mobile,age])) {
      formAlert('Tutti i campi sono obbligatori')
    } else if(!emailValidate(email)) {
      formAlert("L'email inserita non è corretta")
    } else {
      registerUser(user)
    }
  }, false)
}

// DASHBOARD
function dashPage(user) {
  document.getElementById('logout').addEventListener('click', signOut, false)
  if (user) {

    // document.getElementById('dialog')
    // firebase.initializeApp(config)
    var db = firebase.database()
    // var dbRef = db.ref('/events/2017-02-sorrento/users')

    // var dbRef = db.ref('/events/2017-11-paderno/people')
    var dbRef = refPeople
    var people = document.getElementById('people')

// callback version
    // dbRef.on('child_added', (data) => {
    //   var div = document.createElement('div')
    //   div.innerHTML = template.eventPeople(data.val(),data.key)
    //   people.appendChild(div)
    //   document.getElementById(data.key).addEventListener('click', function (){modifyUser(data.key,data.val())}, false)
    // })

// promises version
    refPeople.once('value')
    .then(function (data) {
      store.people = data.val()
      for (let caz in store.people) {
        var div = document.createElement('div')
        div.innerHTML = template.eventPeople(store.people[caz],caz)
        // console.log( template.eventPeople(store.people[caz],caz));
        people.appendChild(div)
        document.getElementById('edit'+caz).addEventListener('click', function (){
          editUser(caz)
        }, false)
      }
    })
    // refPeople.on('child_changed', function () {
    //   console.log('modified')
    // })
  } else {
    if (private) location.href = 'login'
  }
}

window.onload = function() {
  firebase.auth().onAuthStateChanged(function(user) {
    if (/login/.test(location.href)) {
      loginPage(user)
    } else if (/registration/.test(location.href)) {
      registration()
    } else if (/completed/.test(location.href)) {

    } else if (/new/.test(location.href)) {
      newUser()
    } else {
      dashPage(user)
    }
  })
}
</script>

<!-- utilities -->
<script src="/l-amore-chiama-l-amore-e-urgente/assets/js/utils.js"></script>

<!-- templates -->
<script src="/l-amore-chiama-l-amore-e-urgente/assets/js/templates.js"></script>

<!-- dialogs -->
<script src="/l-amore-chiama-l-amore-e-urgente/assets/js/dialogs.js"></script>

<!-- store -->
<script src="/l-amore-chiama-l-amore-e-urgente/assets/js/store.js"></script>


  </body>
</html>
